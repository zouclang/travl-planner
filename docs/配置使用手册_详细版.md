# 旅游规划助手配置包使用手册（详细版）

## 1. 这份配置包包含什么

- `pyproject.toml`
  - 项目脚本入口配置（`trip-planner`、`trip-ticket-mcp`）
  - Python 包元信息与依赖定义
- `env/.env.trip_planner.example`
  - 全量环境变量模板（地图、票务、天气、平台扩展端点）
- `env/.env.weather.example`
  - 天气模块最小配置模板
- `env/.env.wechat_oa.example`
  - 微信公众号模块配置模板
- `templates/request.template.json`
  - 行程请求模板
- `templates/user_profile.template.json`
  - 用户画像模板（完全脱敏）
- `templates/codex.mcp.config.toml.template`
  - MCP 服务接入模板

## 2. 脱敏说明（你可以放心转发）

本包已做脱敏处理：
- 未包含任何 API Key / Secret / Token。
- 未包含任何个人地址、车辆真实信息、家庭成员信息。
- 未包含 `output/` 产物（可能携带行程和个人偏好）。
- 未包含原项目中带个人示例的说明内容。

## 3. 快速上手（新同事）

### 3.1 准备项目代码

这份压缩包是“配置包”，不是完整源码。请先拿到项目源码目录，然后把配置文件放进源码根目录。

### 3.2 复制模板

在项目根目录执行：

```bash
cp env/.env.trip_planner.example .env.trip_planner
cp env/.env.weather.example .env.weather
cp env/.env.wechat_oa.example .env.wechat_oa
cp templates/request.template.json examples/request.json
cp templates/user_profile.template.json examples/user_profile.json
```

### 3.3 填写你自己的配置

至少检查以下项：
- 必填（真实地图能力）：`AMAP_WEB_API_KEY`
- 可选（企业票务）：
  - `CTRIP_TICKET_ENDPOINT` / `CTRIP_CUSTOMER_NO` / `CTRIP_APP_SECRET`
  - `MEITUAN_TICKET_ENDPOINT` / `MEITUAN_APP_ID` / `MEITUAN_APP_SECRET`
- 可选（天气多源）：`WEATHER_PROVIDER_ORDER` 和各源 endpoint

### 3.4 加载环境变量

```bash
source ./.env.trip_planner
source ./.env.weather
source ./.env.wechat_oa
```

## 4. 运行命令说明

### 4.1 安装依赖

```bash
python -m venv .venv
source .venv/bin/activate
pip install -e .
```

### 4.2 生成行程

```bash
trip-planner --input examples/request.json --out-dir output --provider-mode real --theme auto
```

### 4.3 仅离线调试（不依赖真实 API）

```bash
trip-planner --input examples/request.json --out-dir output --provider-mode mock --theme forest
```

### 4.4 仅查天气

```bash
trip-planner --weather-only --weather-city 北京 --weather-date 2026-03-14 --weather-extensions all
```

### 4.5 启动 MCP 服务

```bash
trip-ticket-mcp
```

## 5. 核心配置项解释（按模块）

### 5.1 Provider 模式

- `TRIP_PROVIDER_MODE=real`
  - 优先走真实服务；缺失配置会按代码逻辑自动降级。
- `TRIP_PROVIDER_MODE=mock`
  - 全离线模拟，适合联调和演示。

### 5.2 地图与路线

- `AMAP_WEB_API_KEY`：高德 key，用于地理编码/路径规划/天气兜底。
- `AMAP_BASE_URL`：默认 `https://restapi.amap.com`，通常无需改。

### 5.3 票务

- 携程企业票务：3 个参数必须同时填写。
- 美团企业票务：3 个参数必须同时填写；签名模式通常用 `sha1_wrapped`。
- 两者都不配时，系统会自动降级公开票价页（去哪儿）并在运行输出提示。

### 5.4 天气

- `WEATHER_PROVIDER_ORDER` 决定尝试顺序。
- 若前置源失败，会继续尝试后续源；直到命中可用结构化数据。
- 若你已配置高德 key，可把 `amap` 放在顺序末尾做兜底。

### 5.5 内容平台扩展（可选）

- 美团/点评/抖音/小红书/微信公众号都支持“自定义 endpoint 优先”。
- 未配置时会返回 `unavailable` 或走公开降级能力（具体以模块实现为准）。

## 6. 隐私与安全建议（转发前必看）

- 不要转发你已经填写过真实值的 `.env.*` 文件。
- 推荐只转发 `.example` 模板。
- 把 `.env*` 加入忽略（若团队允许）：

```gitignore
.env
.env.*
!.env.*.example
```

- 避免把 `examples/user_profile.json` 中真实家庭地址提交到仓库。

## 7. 常见问题

### 7.1 报错：缺少 `AMAP_WEB_API_KEY`

原因：运行在 `real` 模式且地图能力未配置。

处理：
1. 在 `.env.trip_planner` 填写 `AMAP_WEB_API_KEY`。
2. `source ./.env.trip_planner` 后重试。

### 7.2 票务一直 unavailable

原因：企业票务凭证未配置或接口权限不足。

处理：
1. 检查携程/美团票务三元组是否完整。
2. 若无企业权限，接受降级路径（公开票价源）。

### 7.3 天气无返回

原因：天气源 endpoint 不可达或格式不兼容。

处理：
1. 调整 `WEATHER_PROVIDER_ORDER`。
2. 暂时保留 `amap` 兜底，并确认 `AMAP_WEB_API_KEY` 生效。

## 8. 推荐交接方式

把以下内容一起发给同事：
- 本配置包 zip
- 项目源码地址（git 仓库）
- 你希望同事使用的最小启动命令（例如第 4.2）

